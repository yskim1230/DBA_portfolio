# PowerShell 스크립트를 이용한 유지보수 자동화 (로그/백업 관리)

## 1) 개요 (Why)
운영 서버의 백업 파일(.bak) 및 트랜잭션 로그 백업(.trn)이 누적되면서 **디스크 용량 압박 → 장애 리스크**가 발생할 수 있어,  
Windows 환경에서 **PowerShell + 작업 스케줄러(Task Scheduler)** 기반으로 **보관 기간(4주) 초과 파일을 자동 정리**하는 체계를 구축했다.

- 대상: MSSQL 백업 산출물(.bak) / 로그백업(.trn)
- 목표:
  - 백업 저장소의 **디스크 사용량을 안정적으로 관리**
  - 정리 작업의 **재현 가능성(스크립트화) + 감사 가능성(로그 증빙) 확보**
  - 운영자가 수동으로 정리하던 반복 작업 제거(운영 자동화)

---

## 2) 운영 정책 (What)
### 보관 정책(Retention)
- **보관기간:** 28일(4주)
- **정리 대상 조건:** `LastWriteTime < (현재 - 28일)`
- **정리 파일 확장자:** `*.bak`, `*.trn`

### 경로 정책(예시)
- 원본(백업 생성 위치): `S:\Backup_db`
- 격리/정리 작업 디렉터리: `S:\baktrn File LIst\Deletebaktrn`
- 로그 파일: `S:\baktrn File LIst\Deletebaktrn\MovedFiles_yyyyMMdd_HHmmss.log`
  - (Moved + Deleted 내역을 한 파일에 남김)

---

## 3) 설계(How) – 자동/수동 시나리오 분리
운영 안정성을 위해 “자동 정리”와 “수동 점검” 스크립트를 분리했다.

### A. 자동(스케줄 기반) – 28일 초과 파일 이동 + 삭제 + 로그 기록
- 스크립트: `(자동)baktrn파일 삭제 스케줄러용.ps1`
- 동작 요약:
  1) 원본 디렉터리 재귀 탐색(Include: `.bak`, `.trn`)
  2) 28일 초과 파일 필터링
  3) DB명(폴더명) 기준으로 대상 디렉터리에 **분리 보관(이동)**
  4) 이동 성공한 파일 목록만 대상으로 **삭제 진행**
  5) 이동/삭제/실패/요약을 **로그에 기록**

> 운영 관점 코멘트(중요):  
> 현재 자동 스크립트는 **이동 후 즉시 삭제** 구조다. “삭제 전 격리 보관 기간”이 필요하다면,  
> **(이동 → N일 보관 → 삭제)**로 2단계 분리하는 개선이 바람직하다.

### B. 수동(운영자 점검용) – 기한 초과 파일 추출/이동/삭제를 단계별 실행
- `(수동)baktrn 기한 지난것 추출 스크립트.ps1`
  - 기한 초과 파일을 **DB별 폴더로 이동**(삭제 없음)
- `(수동)baktrn 기한 지난것 추출 및 삭제 스크립트.ps1`
  - 기한 초과 파일을 이동 후, 사용자 확인(Yes/No) 기반으로 **삭제**

---

## 4) 구현 상세 – 핵심 로직
### 자동 스크립트 핵심 파라미터
- 기준일 계산: `Get-Date).AddDays(-28)`
- 대상 파일: `Get-ChildItem -Recurse -Include *.bak, *.trn`
- 필터: `LastWriteTime < thresholdDate`
- 로그 파일명: `MovedFiles_yyyyMMdd_HHmmss.log`
- DB별 분리: `Split-Path $file.DirectoryName -Leaf`

### 자동 스크립트 주요 흐름(의사 코드)
```powershell
sourceRoot = "S:\Backup_db"
targetRoot = "S:\baktrn File LIst\Deletebaktrn"
thresholdDate = now - 28days
logFile = "MovedFiles_{timestamp}.log"

oldFiles = Get-ChildItem(sourceRoot, *.bak/*.trn, recursive)
          where LastWriteTime < thresholdDate

foreach file in oldFiles:
  dbName = leaf(file.DirectoryName)
  ensure targetRoot\dbName exists
  move file -> targetRoot\dbName\file
  append log: Moved

foreach movedFile in movedFiles:
  delete movedFile
  append log: Deleted

append log summary: movedCount / deleteCount / completedAt
```



## 5) 스케줄링(운영 적용)

Windows 작업 스케줄러에 등록하여 정기 수행되도록 구성했다.

* 실행 프로그램: `powershell.exe`
* 인자 예시:

  * `-ExecutionPolicy Bypass -File "S:\baktrn File LIst\(자동)baktrn파일 삭제 스케줄러용.ps1"`

---

## 6) 산출물(증빙)


### A. 작업 스케줄러 등록 증빙

* `백업삭제스케줄(윈도우).png`



> 첨부:
<img width="1980" height="1144" alt="백업삭제스케줄(윈도우)" src="https://github.com/user-attachments/assets/124cd455-1dfb-42fe-951d-5e7dcd07089b" />


### B. 실행 로그 증빙(이동/삭제 내역)

* 예시 로그 파일:

  * `MovedFiles_20260112_073403.log`
  * `MovedFiles_20251117_142836.log`
  * `MovedFiles_20251016_084346.log`
  * `MovedFiles_20250917_130224.log`

로그에는 아래 정보가 남는다.

* `Moved: <원본경로> -> <대상경로> | LastModified: <시간>`
* `Deleted: <대상경로>`
* Summary(이동/삭제 건수, 완료 시각)


---

## 7) 운영 효과

* 백업/로그 파일 누적에 따른 **디스크 Full 위험 감소**
* 반복적인 정리 작업을 스크립트화하여 **운영 자동화 및 인적 실수 감소**
* 로그 기반으로 “언제/무엇을/얼마나” 정리했는지 **감사 추적 가능**

---

## 8) 리스크 및 개선 포인트

* 개선안:

  1. `Deletebaktrn` 아래로 이동만 수행(1차)
  2. `Deletebaktrn` 내 파일 중 “이동 후 N일 경과” 조건으로 삭제(2차)
  3. 로그 파일을 `Moved` / `Deleted`로 분리하여 감사 가독성 개선
