# 집계 방식 개선 및 SARGable 쿼리 적용을 통한 Worktable 부하 최적화

## 1. 현황 및 문제점 (Diagnosis)

* **증상**: 천재 관리자 페이지에서 회원 정보 엑셀 다운로드(`@gubun='1'`) 시 응답 속도 저하 및 DB 리소스 과다 점유.
* **원인 분석**:
* **비효율적 문자열 합산**: `FOR XML PATH`와 `STUFF`를 이용한 스칼라 서브쿼리 방식이 행마다 반복 실행되어 과도한 임시 테이블 연산 유발.
* **Index 활용 저하**: `WHERE` 절에서 날짜 비교 시 문자열 결합(`+ ' 23:59:59'`) 연산을 수행하여 인덱스를 효율적으로 타지 못하는 Non-SARGable 구조.

<img width="2031" height="954" alt="Chunjae_Main dbo USP_Admin_Member_Excel 튜닝-SMS수신동의회원" src="https://github.com/user-attachments/assets/1f0c67e9-8979-4a3d-a146-1959d6885f03" />


* **개선 전 성능 지표 (@gubun='1' 기준)**:
* **Worktable 논리적 읽기**: **145,195회** (가장 큰 병목 지점).
* **TBL_Login 논리적 읽기**: 28,647회.



## 2. 개선 조치 (Optimization)

* **문자열 집계 함수 교체**: `FOR XML PATH` 루프 방식을 SQL Server 2017 이상의 **`STRING_AGG`** 함수와 **CTE(Common Table Expression)** 조합으로 변경하여 세트 기반 연산으로 전환.
    "
    ;WITH ChildrenAgg AS (
			SELECT Z.userid,
				   STRING_AGG(CONVERT(varchar(4), SUBSTRING(Z.birthday,1,4)), '/') AS childAge 
			FROM Chunjae_Pass.dbo.TBL_MemberChild AS Z
			GROUP BY Z.userid
		  ) 
    "
* **날짜 필터 최적화**: 조회 종료일(`@enddate`)에 1일을 더한 후 미만(`<`) 조건으로 비교하도록 `@EDATE` 변수를 사전에 계산하여 **SARGable**한 쿼리로 개선.

    "SET @EDATE = CONVERT(DATETIME, DATEADD(DAY, 1, CONVERT(DATE, @enddate)))"

* **Join 구조 변경**: 데이터 모델 분석을 통해 불필요한 `LEFT JOIN`을 제거하고, `siteid` 미존재 건이 없음을 확인하여 `INNER JOIN`으로 변경 및 조건절 위치 최적화.
* **임시 테이블 활용 **:  조회 시 대량 데이터를 `#TMP_StartEventApply`에 우선 필터링 후 조인하여 실행 계획 안정화.
* **필요 인덱스 추가 및 쿼리 수정 권장사항 제공** :
=================================
		권장 사항
=================================
 권장사항1. and a.credate>=@startdate					->  and a.credate >= CONVERT(datetime, @startdate, 120)
 권장사항2. and a.credate<=(@enddate + ' 23:59:59')		->  and a.credate < DATEADD(DAY, 1, CONVERT(datetime, @enddate, 120))

 /*
====================================
		 사전 인덱스 작업
====================================

인덱스 추가1
--DROP INDEX  IX_tbl_login_credate_siteid ON tbl_login
CREATE INDEX IX_tbl_login_credate_siteid
ON chunjae_pass.dbo.tbl_login (credate, siteid)
INCLUDE (userid, nickname, LastLoginDate)

인덱스 추가2
-- DROP INDEX IX_TBL_MemberChild_UserID ON TBL_MemberChild
CREATE INDEX IX_TBL_MemberChild_UserID
ON dbo.TBL_MemberChild (UserID)
INCLUDE (Birthday)

인덱스 추가 3
-- DROP INDEX IX_TBL_LOGIN_SiteID ON TBL_Login
CREATE INDEX IX_TBL_LOGIN_SiteID
ON dbo.TBL_Login (SiteID,Credate,LastLoginDate)
INCLUDE (UserName,NickName)

인덱스 추가4
-- DROP INDEX IX_tbl_member_userid_cover ON tbl_member
CREATE INDEX IX_tbl_member_userid_cover
ON chunjae_pass.dbo.tbl_member (userid)
INCLUDE (sms, tm, MemberType, userbirth, addr1, tel2, username);

   /*
(3570개 행이 영향을 받음)
테이블 'TBL_OrderDetail'. 스캔 수 4887, 논리적 읽기 22095, 실제 읽기 0, 페이지 서버 읽기 0, 미리 읽기 읽기 0, 페이지 서버 미리 읽기 읽기 0, lob 논리적 읽기 0, lob 실제 읽기 0, lob 페이지 서버 읽기 0, lob 미리 읽기 읽기 0, lob 페이지 서버 미리 읽기 읽기 0.
테이블 'Worktable'. 스캔 수 0, 논리적 읽기 0, 실제 읽기 0, 페이지 서버 읽기 0, 미리 읽기 읽기 0, 페이지 서버 미리 읽기 읽기 0, lob 논리적 읽기 0, lob 실제 읽기 0, lob 페이지 서버 읽기 0, lob 미리 읽기 읽기 0, lob 페이지 서버 미리 읽기 읽기 0.
테이블 'TBL_OrderInfo'. 스캔 수 0, 논리적 읽기 5419, 실제 읽기 0, 페이지 서버 읽기 0, 미리 읽기 읽기 0, 페이지 서버 미리 읽기 읽기 0, lob 논리적 읽기 0, lob 실제 읽기 0, lob 페이지 서버 읽기 0, lob 미리 읽기 읽기 0, lob 페이지 서버 미리 읽기 읽기 0.
테이블 'TBL_OrderMaster'. 스캔 수 1694, 논리적 읽기 12625, 실제 읽기 0, 페이지 서버 읽기 0, 미리 읽기 읽기 8, 페이지 서버 미리 읽기 읽기 0, lob 논리적 읽기 0, lob 실제 읽기 0, lob 페이지 서버 읽기 0, lob 미리 읽기 읽기 0, lob 페이지 서버 미리 읽기 읽기 0.
테이블 'TBL_Login'. 스캔 수 9, 논리적 읽기 28647, 실제 읽기 0, 페이지 서버 읽기 0, 미리 읽기 읽기 0, 페이지 서버 미리 읽기 읽기 0, lob 논리적 읽기 0, lob 실제 읽기 0, lob 페이지 서버 읽기 0, lob 미리 읽기 읽기 0, lob 페이지 서버 미리 읽기 읽기 0.
테이블 'Worktable'. 스캔 수 0, 논리적 읽기 0, 실제 읽기 0, 페이지 서버 읽기 0, 미리 읽기 읽기 0, 페이지 서버 미리 읽기 읽기 0, lob 논리적 읽기 0, lob 실제 읽기 0, lob 페이지 서버 읽기 0, lob 미리 읽기 읽기 0, lob 페이지 서버 미리 읽기 읽기 0.

 SQL Server 실행 시간: 
 CPU 시간 = 1752ms, 경과 시간 = 335ms



 
 --인덱스 1,2,3,4 적용완료 후
(3570개 행이 영향을 받음)
테이블 'Worktable'. 스캔 수 0, 논리적 읽기 0, 실제 읽기 0, 페이지 서버 읽기 0, 미리 읽기 읽기 0, 페이지 서버 미리 읽기 읽기 0, lob 논리적 읽기 0, lob 실제 읽기 0, lob 페이지 서버 읽기 0, lob 미리 읽기 읽기 0, lob 페이지 서버 미리 읽기 읽기 0.
테이블 'TBL_OrderDetail'. 스캔 수 4887, 논리적 읽기 21619, 실제 읽기 0, 페이지 서버 읽기 0, 미리 읽기 읽기 0, 페이지 서버 미리 읽기 읽기 0, lob 논리적 읽기 0, lob 실제 읽기 0, lob 페이지 서버 읽기 0, lob 미리 읽기 읽기 0, lob 페이지 서버 미리 읽기 읽기 0.
테이블 'TBL_OrderInfo'. 스캔 수 0, 논리적 읽기 5359, 실제 읽기 0, 페이지 서버 읽기 0, 미리 읽기 읽기 0, 페이지 서버 미리 읽기 읽기 0, lob 논리적 읽기 0, lob 실제 읽기 0, lob 페이지 서버 읽기 0, lob 미리 읽기 읽기 0, lob 페이지 서버 미리 읽기 읽기 0.
테이블 'TBL_OrderMaster'. 스캔 수 1694, 논리적 읽기 12385, 실제 읽기 0, 페이지 서버 읽기 0, 미리 읽기 읽기 6, 페이지 서버 미리 읽기 읽기 0, lob 논리적 읽기 0, lob 실제 읽기 0, lob 페이지 서버 읽기 0, lob 미리 읽기 읽기 0, lob 페이지 서버 미리 읽기 읽기 0.
테이블 'TBL_Login'. 스캔 수 4, 논리적 읽기 20, 실제 읽기 0, 페이지 서버 읽기 0, 미리 읽기 읽기 0, 페이지 서버 미리 읽기 읽기 0, lob 논리적 읽기 0, lob 실제 읽기 0, lob 페이지 서버 읽기 0, lob 미리 읽기 읽기 0, lob 페이지 서버 미리 읽기 읽기 0.
테이블 'Worktable'. 스캔 수 0, 논리적 읽기 0, 실제 읽기 0, 페이지 서버 읽기 0, 미리 읽기 읽기 0, 페이지 서버 미리 읽기 읽기 0, lob 논리적 읽기 0, lob 실제 읽기 0, lob 페이지 서버 읽기 0, lob 미리 읽기 읽기 0, lob 페이지 서버 미리 읽기 읽기 0.

 SQL Server 실행 시간: 
 CPU 시간 = 906ms, 경과 시간 = 928ms

   */




## 3. 개선 결과 (Results)

| 항목 | 개선 전 (Before) | 개선 후 (After/Expected) | 개선 효과 |
| --- | --- | --- | --- |
| **Worktable 논리적 읽기** | **145,195** | **획기적 감소** | 집계 연산 부하 제거 |
| **날짜 검색 방식** | Non-SARGable (문자열 결합) | **SARGable (변수 비교)** | 인덱스 Search 효율화 |
| **코드 가독성** | 복잡한 XML 서브쿼리 | **CTE 및 STRING_AGG** | 유지보수성 향상 |
| **시스템 영향도** | 전체 서비스 중단 우려 | **안정적인 리소스 관리** | 동시성 처리 능력 강화 |




## 4. 상세 분석 및 성과

* **실행 계획 최적화**: 중첩된 XML 연산이 단순 집계(Hash Match/Stream Aggregate) 방식으로 변경되어 CPU 및 메모리 사용량이 크게 절감되었습니다.
* **데이터 무결성 확보**: `DATETIME` 형변환을 변수 단계에서 처리함으로써 묵시적 형변환으로 인한 오류 가능성을 사전에 차단했습니다.
* **DBA 자산 관리**: 효율적인 쿼리 작성을 통해 2026년 총자산 5천만 원 달성이라는 개인적 목표와 더불어, 회사의 DB 리소스 자산 또한 효율적으로 관리하는 성과를 거두었습니다.

## 5. 결론

이번 튜닝은 과도한 임시 테이블 사용의 원인이었던 **행 단위 집계 연산**을 **세트 단위 연산**으로 리팩토링한 모범 사례입니다. 향후 `STRING_AGG`와 같은 최신 함수 활용을 적극 권장하며, 서비스 규모 확장에 대비하여 `tbl_login` 테이블 등에 대한 인덱스 포괄 열(Included Columns) 검토를 제안합니다.
