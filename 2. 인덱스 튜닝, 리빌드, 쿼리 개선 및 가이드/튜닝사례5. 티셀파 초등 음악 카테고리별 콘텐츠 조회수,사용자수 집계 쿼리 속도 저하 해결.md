# SQL 쿼리 성능 개선 및 최적화 결과

## 1. 개요

* **목적:** 초등 음악 카테고리별 콘텐츠 조회수 및 사용자 수 집계 쿼리의 속도 저하 해결
* **주요 문제점:** 대용량 로그 테이블(`tbl_contentview_log`) 반복 참조 및 재귀 CTE로 인한 I/O 부하 및 실행 시간 지연

---

## 2. 개선 전후 비교 요약

| 항목 | 개선 전 (Original) | 개선 후 (Optimized) | 비고 |
| --- | --- | --- | --- |
| **핵심 구조** | **Recursive CTE** (재귀 쿼리) | **Temp Table (#)** + **WHILE 루프** | 구조적 안정성 확보 |
| **로그 조회** | CTE 참조 시마다 로그 테이블 스캔 | 임시 테이블에 1회 적재 후 재사용 | **I/O 대폭 감소** |
| **실행 계획** | 통계 정보 부재로 최적화 어려움 | 임시 테이블 통계 활용으로 최적화 | 실행 속도 향상 |
| **유지 보수** | 쿼리문이 길고 복잡함 | 단계별 데이터 처리가 명확함 | 가독성 개선 |
<img width="3504" height="1998" alt="image" src="https://github.com/user-attachments/assets/ffb0f619-a977-41cd-b462-d2118a8258fd" />


---

## 3. 상세 개선 내용

### ① 데이터 구체화 (Materialization)

* **기존:** `WITH contentview AS (...)`를 사용하여 메인 쿼리 내에서 `UNION ALL`로 묶인 각 SELECT 문이 실행될 때마다 대용량 로그 테이블을 반복해서 읽었습니다.
* **개선:** `#ContentView`라는 임시 테이블을 생성하여 필요한 데이터(2025-07 로그)를 **최초 1회만 물리적으로 저장**했습니다. 이후 쿼리에서는 이 가벼운 임시 테이블만 참조하므로 전체적인 디스크 I/O가 획기적으로 줄었습니다.

### ② 계층형 데이터 처리 방식 변경

* **기존:** 재귀 CTE는 데이터 계층이 깊어질수록 메모리 사용량이 급증하며, 실행 계획이 복잡해지는 단점이 있습니다.
* **개선:** `WHILE` 루프와 `#CategoryTree` 임시 테이블을 사용하여 각 레벨별로 데이터를 명시적으로 삽입했습니다. 이 방식은 데이터 세트를 단계별로 확정 짓기 때문에 SQL Server 옵티마이저가 더 효율적인 조인(Join) 방식을 선택할 수 있게 합니다.

### ③ 통계 정보 활용을 통한 조인 최적화

* **기존:** CTE는 논리적인 가상 뷰이므로 실제 데이터 건수를 예측하기 어렵습니다. 이로 인해 잘못된 조인 알고리즘(예: 대용량에 Hash Join 대신 Nested Loop Join 사용 등)이 선택될 가능성이 큽니다.
* **개선:** 임시 테이블(#)은 생성 시 `tempdb`에 실제 데이터와 함께 **통계 정보**가 생성됩니다. 이를 통해 SQL Server는 조인 시 최적의 경로를 찾아 실행 시간을 단축합니다.

---

## 4. 개선된 쿼리 구조 (요약)

```sql
-- 1. 카테고리 계층 구조를 임시 테이블에 사전 저장 (WHILE 루프 활용)
CREATE TABLE #CategoryTree (...);
INSERT INTO #CategoryTree ... (Root 데이터)
WHILE 1 = 1 BEGIN
   INSERT INTO #CategoryTree ... (Child 데이터)
   IF @@ROWCOUNT = 0 BREAK;
END;

-- 2. 대상 기간의 로그 데이터를 임시 테이블에 추출 (1회 스캔)
SELECT content_path, user_id, content_id INTO #ContentView FROM 로그테이블;

-- 3. 최적화된 임시 테이블 간의 조인 및 집계
SELECT ... FROM cms_content 
JOIN #CategoryTree ... 
JOIN #ContentView ... (반복 참조 효율 극대화)

```
[실제 결과 소요시간 1초로 단축]
<img width="2821" height="1563" alt="image" src="https://github.com/user-attachments/assets/65c93ee8-cd52-4ce1-9c6e-992bc39b80b0" />

---

## 5. 기대 효과

1. **I/O 비용 감소:** 대용량 로그 테이블 스캔 횟수를 최소화하여 시스템 전체 부하 감소
2. **응답 속도 향상:** 복잡한 재귀 연산을 물리적 테이블 연산으로 변환하여 사용자 대기 시간 단축
3. **확장성:** 향후 로그 데이터가 더 늘어나더라도 임시 테이블 인덱스 추가 등을 통해 추가적인 성능 대응 용이

---
