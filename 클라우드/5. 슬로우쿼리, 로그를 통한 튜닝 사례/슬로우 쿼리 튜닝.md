# 튜닝 전 원문 쿼리
[원문]
```
SELECT
    TS.LU_LRMP_NOD_ID, /*단원ID*/
    EE.EV_DTL_DV_CD, /*평가상세구분코드*/
    COUNT(DISTINCT ER.USR_ID) AS ev_able_count, /*응시가능인원수*/
    COUNT(DISTINCT CASE 
        WHEN NOT EXISTS (
            SELECT 1 
            FROM LMS_LRM.EA_EV sub_ee
            JOIN LMS_LRM.EA_EV_RS sub_er ON sub_er.EV_ID = sub_ee.EV_ID
            JOIN LMS_LRM.EA_EV_TS_RNGE sub_ts ON sub_ts.EV_ID = sub_ee.EV_ID
            WHERE sub_er.USR_ID = ER.USR_ID
              AND sub_er.EV_CMPL_YN = 'S'
              AND sub_ee.OPT_TXB_ID = 'S'
              AND sub_ee.EV_DV_CD = 'S'
              AND sub_ee.EV_DTL_DV_CD = EE.EV_DTL_DV_CD
              AND sub_ts.LU_LRMP_NOD_ID = TS.LU_LRMP_NOD_ID
        ) THEN ER.USR_ID 
    END) AS not_submitted_count, /*미응시인원수*/
    GROUP_CONCAT(DISTINCT CASE 
        WHEN NOT EXISTS (
            SELECT 1 
            FROM LMS_LRM.EA_EV sub_ee
            JOIN LMS_LRM.EA_EV_RS sub_er ON sub_er.EV_ID = sub_ee.EV_ID
            JOIN LMS_LRM.EA_EV_TS_RNGE sub_ts ON sub_ts.EV_ID = sub_ee.EV_ID
            WHERE sub_er.USR_ID = ER.USR_ID
              AND sub_er.EV_CMPL_YN = 'S'
              AND sub_ee.OPT_TXB_ID = 'S'
              AND sub_ee.EV_DV_CD = 'S'
              AND sub_ee.EV_DTL_DV_CD = EE.EV_DTL_DV_CD
              AND sub_ts.LU_LRMP_NOD_ID = TS.LU_LRMP_NOD_ID
        ) THEN CM.USR_ID 
    END ORDER BY CM.USR_ID SEPARATOR ', ') AS not_submitted_names, /*미응시학생이름 - SEPARATOR 수정*/
    COUNT(DISTINCT CASE WHEN EE.EV_DTL_DV_CD = 'S' THEN EE.EV_ID END) AS total_fo_count,
    COUNT(DISTINCT CASE 
        WHEN EE.EV_DTL_DV_CD = 'S' 
        AND EXISTS (
            SELECT 1 FROM LMS_LRM.EA_EV_RS sub_er 
            WHERE sub_er.EV_ID = EE.EV_ID 
              AND sub_er.STU_EV_ABLE_YN = 'S' 
              AND sub_er.EV_CMPL_YN = 'S'
        ) THEN EE.EV_ID 
    END) AS completed_fo_count,
    COUNT(DISTINCT CASE WHEN EE.EV_DTL_DV_CD = 'S' THEN EE.EV_ID END) AS total_to_count,
    COUNT(DISTINCT CASE 
        WHEN EE.EV_DTL_DV_CD = 'S' 
        AND EXISTS (
            SELECT 1 FROM LMS_LRM.EA_EV_RS sub_er 
            WHERE sub_er.EV_ID = EE.EV_ID 
              AND sub_er.STU_EV_ABLE_YN = 'S' 
              AND sub_er.EV_CMPL_YN = 'S'
        ) THEN EE.EV_ID 
    END) AS completed_to_count
FROM LMS_LRM.EA_EV EE
JOIN LMS_LRM.EA_EV_RS ER ON EE.EV_ID = ER.EV_ID AND ER.STU_EV_ABLE_YN = 'S'
JOIN LMS_LRM.CM_USR CM ON CM.USR_ID = ER.USR_ID AND CM.USR_TP_CD = 'S'
JOIN LMS_LRM.EA_EV_TS_RNGE TS ON TS.EV_ID = EE.EV_ID AND TS.LU_OPT_TXB_ID = EE.OPT_TXB_ID
WHERE EE.OPT_TXB_ID = 'S'
  AND EE.EV_DV_CD = 'S'
  AND EE.EV_DTL_DV_CD IN ('S', 'S', 'S')
GROUP BY TS.LU_LRMP_NOD_ID, EE.EV_DTL_DV_CD
ORDER BY TS.LU_LRMP_NOD_ID, EE.EV_DTL_DV_CD
```

<img width="2137" height="422" alt="1차튜닝 완료 explain" src="https://github.com/user-attachments/assets/52683548-da10-41fa-82b2-d2c53dda1490" />



# 튜닝 결과 요약 (EXPLAIN 기반)

## 1. 개선 전 병목(AS-IS)

* DEPENDENT SUBQUERY 다수 발생
  외부 row마다 NOT EXISTS, EXISTS가 반복 실행되는 구조
* done_ev 계산을 위해 EA_EV_RS 전체(약 129만 rows) 스캔 발생
  매 실행마다 큰 테이블을 한 번 훑는 구조적 비용이 존재

## 2. 개선 후 구조(TO-BE v2)에서 EXPLAIN이 보여주는 개선

[개선 쿼리]

[최종수정]
```
SELECT
TS.LU_LRMP_NOD_ID,
EE.EV_DTL_DV_CD,
COUNT(DISTINCT ER.USR_ID) AS ev_able_count,
COUNT(DISTINCT IF(done_u.USR_ID IS NULL, ER.USR_ID, NULL)) AS not_submitted_count,
GROUP_CONCAT(
    DISTINCT IF(done_u.USR_ID IS NULL, CM.USR_ID, NULL)
    ORDER BY CM.USR_ID SEPARATOR ', '
) AS not_submitted_names,
COUNT(DISTINCT EE.EV_ID) AS total_fo_count,
COUNT(DISTINCT IF(ER.EV_CMPL_YN = 'S', EE.EV_ID, NULL)) AS completed_fo_count,
COUNT(DISTINCT EE.EV_ID) AS total_to_count,
COUNT(DISTINCT IF(ER.EV_CMPL_YN = 'S', EE.EV_ID, NULL)) AS completed_to_count
FROM LMS_LRM.EA_EV EE
JOIN LMS_LRM.EA_EV_RS ER
  ON ER.EV_ID = EE.EV_ID
 AND ER.STU_EV_ABLE_YN = 'S'
JOIN LMS_LRM.CM_USR CM
  ON CM.USR_ID = ER.USR_ID
 AND CM.USR_TP_CD = 'S'
JOIN LMS_LRM.EA_EV_TS_RNGE TS
  ON TS.EV_ID = EE.EV_ID
 AND TS.LU_OPT_TXB_ID = EE.OPT_TXB_ID
LEFT JOIN (
    SELECT DISTINCT
        sub_er.USR_ID,
        sub_ts.LU_LRMP_NOD_ID,
        sub_ee.EV_DTL_DV_CD
    FROM LMS_LRM.EA_EV sub_ee
    JOIN LMS_LRM.EA_EV_RS sub_er
      ON sub_er.EV_ID = sub_ee.EV_ID
     AND sub_er.STU_EV_ABLE_YN = 'S'
     AND sub_er.EV_CMPL_YN = 'S'
    JOIN LMS_LRM.EA_EV_TS_RNGE sub_ts
      ON sub_ts.EV_ID = sub_ee.EV_ID
     AND sub_ts.LU_OPT_TXB_ID = sub_ee.OPT_TXB_ID
    WHERE sub_ee.OPT_TXB_ID = 'S'
      AND sub_ee.EV_DV_CD   = 'S'
      AND sub_ee.EV_DTL_DV_CD = 'S'
) done_u
  ON done_u.USR_ID = ER.USR_ID
 AND done_u.LU_LRMP_NOD_ID = TS.LU_LRMP_NOD_ID
 AND done_u.EV_DTL_DV_CD = EE.EV_DTL_DV_CD
WHERE EE.OPT_TXB_ID = 'S'
  AND EE.EV_DV_CD   = 'S'
  AND EE.EV_DTL_DV_CD = 'S'
GROUP BY TS.LU_LRMP_NOD_ID, EE.EV_DTL_DV_CD
ORDER BY TS.LU_LRMP_NOD_ID, EE.EV_DTL_DV_CD;
```

----------------------------------------------------------------------

+----+-------------+------------+------------+--------+------------------------------------------+-------------+---------+---------------------------------------------------------------------+------+----------+----------------------------------------------+
| id | select_type | table      | partitions | type   | possible_keys                            | key         | key_len | ref                                                                 | rows | filtered | Extra                                        |
+----+-------------+------------+------------+--------+------------------------------------------+-------------+---------+---------------------------------------------------------------------+------+----------+----------------------------------------------+
|  1 | PRIMARY     | EE         | NULL       | ref    | PRIMARY,EA_EV_IX01,EA_EV_IX03,EA_EV_IX04 | EA_EV_IX01  | 602     | const                                                               |    1 |     5.00 | Using where; Using temporary; Using filesort |
|  1 | PRIMARY     | TS         | NULL       | ref    | PRIMARY,EA_EV_TS_RNGE_IX04               | PRIMARY     | 8       | lms_lrm.EE.EV_ID                                                    |    1 |     4.05 | Using where                                  |
|  1 | PRIMARY     | ER         | NULL       | ref    | PRIMARY,EA_EV_RS_IX01,BC_KMMP_NOD_IX02   | PRIMARY     | 8       | lms_lrm.EE.EV_ID                                                    |    7 |    10.00 | Using where                                  |
|  1 | PRIMARY     | CM         | NULL       | eq_ref | PRIMARY                                  | PRIMARY     | 258     | lms_lrm.ER.USR_ID                                                   |    1 |    10.00 | Using where                                  |
|  1 | PRIMARY     | <derived2> | NULL       | ref    | <auto_key0>                              | <auto_key0> | 278     | lms_lrm.ER.USR_ID,lms_lrm.TS.LU_LRMP_NOD_ID,lms_lrm.EE.EV_DTL_DV_CD |    2 |   100.00 | Using index                                  |
|  2 | DERIVED     | sub_ee     | NULL       | ref    | PRIMARY,EA_EV_IX01,EA_EV_IX03,EA_EV_IX04 | EA_EV_IX01  | 602     | const                                                               |    1 |     5.00 | Using where; Using temporary                 |
|  2 | DERIVED     | sub_ts     | NULL       | ref    | PRIMARY,EA_EV_TS_RNGE_IX04               | PRIMARY     | 8       | lms_lrm.sub_ee.EV_ID                                                |    1 |     4.05 | Using where                                  |
|  2 | DERIVED     | sub_er     | NULL       | ref    | PRIMARY                                  | PRIMARY     | 8       | lms_lrm.sub_ee.EV_ID                                                |    7 |     1.00 | Using where                                  |
+----+-------------+------------+------------+--------+------------------------------------------+-------------+---------+---------------------------------------------------------------------+------+----------+----------------------------------------------+
8 rows in set, 1 warning (0.00 sec)




### A. 대형 풀스캔 제거

* 현재 EXPLAIN에는 derived3가 없음
  EA_EV_RS 129만 rows 스캔 경로가 사라진 것으로 확인
* 메인 집계에서 ER.EV_CMPL_YN = 'S' 조건으로 완료 여부를 계산하도록 변경한 효과

<img width="2080" height="220" alt="최종튜닝 완료 explain" src="https://github.com/user-attachments/assets/bc9e71ea-d0e0-43a3-b012-533c867d51bd" />


### B. 상관 서브쿼리 제거

* DEPENDENT SUBQUERY가 없음
  row 단위 반복 실행 구조가 제거됨

### C. 파생테이블은 1개(derived2, done_u)만 존재

* derived2는 조인키(auto_key0)로 붙고 Using index로 표시됨
  MySQL이 파생 결과에 자동 키를 생성해 조인 효율을 확보한 상태
* 비용 구조가 반복 실행이 아니라 1회 산출 후 조인 형태로 전환됨

## 3. 남아있는 Using temporary, Using filesort의 의미

* EXPLAIN 상단에서 EE에 Using temporary, Using filesort가 보임
* 이는 현 쿼리 형태상 자연스러운 비용으로 남을 수 있음

발생 요인

* GROUP BY TS.LU_LRMP_NOD_ID, EE.EV_DTL_DV_CD
* ORDER BY가 동일 키
* GROUP_CONCAT(DISTINCT ... ORDER BY ...) 포함

이 조합은 MySQL에서 임시테이블과 정렬이 동반되기 쉬움.
다만 이번 케이스의 1순위 병목은 이미 제거됨(129만 스캔, 상관서브쿼리).
남은 비용은 집계와 문자열 결합 성격이므로 추가 최적화는 필요 시점에 단계적으로 접근하는 전략이 합리적임.





## 4. 결론

* 본 쿼리의 핵심 병목은 인덱스 부족이라기보다 상관 서브쿼리 반복 실행과 완료 여부 계산을 위한 대형 테이블 풀스캔에 기인함
* 1차 개선으로 쿼리를 리라이트하여 상관 서브쿼리를 제거했고, 완료 여부는 메인 조인 데이터에서 직접 집계하도록 변경하여 EA_EV_RS 전체 스캔 비용을 제거함(EXPLAIN 근거)
* 현재는 구조 개선 효과가 핵심이며, 향후 데이터 증가로 derived2(done_u) 산출 비용 또는 집계와 정렬 비용이 다시 증가하는 시점에 한해 EA_EV_RS, EA_EV_TS_RNGE 중심의 복합 인덱스 추가를 단계적으로 검토하는 전략을 권장함

---
